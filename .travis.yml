language: go
go:
  - '1.12.3'

go_import_path: github.com/markphelps/flipt

env:
  - GO111MODULE=off

services:
  - docker

stages:
  - lint
  - test
  - name: integration
    if: branch = master OR type = pull_request

jobs:
  include:
  - stage: lint
    before_script:
      - go install github.com/golangci/golangci-lint/cmd/golangci-lint
    script:
      - golangci-lint run

  - stage: test
    before_script:
      - go get github.com/mattn/goveralls
    script:
      - $GOPATH/bin/goveralls -service=travis-ci

  - stage: integration
    before_script:
      - ./scripts/build
    script:
      - docker run --rm -p 8080:8080 -d --name flipt markphelps/flipt:latest
      - sleep 5
      - ./scripts/integration
    after_script:
      - docker stop flipt

notifications:
  email: false
